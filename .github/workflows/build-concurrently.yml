name: build-demos-concurrently

on:
    push:
        branches: [master]
    workflow_dispatch:
    repository_dispatch:

jobs:
    get-demos:
        runs-on: ubuntu-latest
        outputs:
            result: ${{ steps.find-demos.outputs.result }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                clean: 'false'
            - name: Checkout demos repository
              uses: actions/checkout@v4
              with:
                repository: 'HaxeFlixel/flixel-demos'
                submodules: 'recursive'
                ref: 'dev'
                clean: 'false'
                path: 'demos'
            - name: Find all demo folders
              uses: actions/github-script@v7
              id: find-demos
              with:
                retries: 3
                script: |
                  // runs the script to get all the demo folders
                  // and returns the output, which will be an array
                  // of paths
                  // note: actions/github-script will encode the result
                  // in JSON! we decode it later
                  
                  const script = require("./js/getDemos.js");
                  return script({core});
                
    build-demo:
        runs-on: ubuntu-latest
        needs: get-demos
        strategy:
            matrix:
                demo-path: ${{ fromJson(needs.get-demos.outputs.result) }}
        steps:
            - name: Checkout demos repository
              uses: actions/checkout@v4
              with:
                repository: 'HaxeFlixel/flixel-demos'
                submodules: 'recursive'
                ref: 'dev'
                clean: 'false'
                sparse-checkout: ${{ matrix.demo-path }}
            - run: ls